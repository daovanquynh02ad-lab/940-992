<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–§–∏–∑–∏–æ–ª–æ–≥–∏—è (–¢–µ—Å—Ç-–î—Ä–∞–π–≤)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #F4F4F5;
            --card-bg: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #52525B;
            --accent-yellow: #FFDD00;
            --accent-yellow-dark: #E6C600;
            --text-on-accent: #000000;
            --border: #E4E4E7;
            
            --success: #10B981;
            --success-light: #F0FDF4;
            --error: #EF4444;
            --error-light: #FEF2F2;
            
            --tg-color: #2481cc;
            --font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        [data-theme="dark"] {
            --bg: #18181B;
            --card-bg: #27272A;
            --text-primary: #FFFFFF;
            --text-secondary: #A1A1AA;
            --accent-yellow: #FFDD00;
            --accent-yellow-dark: #FFEC80;
            --text-on-accent: #000000;
            --border: #3F3F46;

            --success: #22C55E;
            --success-light: #166534;
            --error: #F87171;
            --error-light: #7F1D1D;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body {
            font-family: var(--font);
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 640px;
            width: 100%;
            margin: 0 auto;
            padding: 20px 20px 140px 20px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è —Ñ—É—Ç–µ—Ä–∞ */
        }

        /* --- –≠–ö–†–ê–ù–´ --- */
        .screen { display: none; flex-direction: column; width: 100%; flex: 1; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease-out; }
        
        /* --- –°–¢–ê–†–¢–û–í–´–ô –≠–ö–†–ê–ù --- */
        .start-header { margin: 40px 0; }
        .start-header h1 { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; }
        .start-header p { font-size: 1.1rem; color: var(--text-secondary); line-height: 1.6; }
        
        .start-controls { display: flex; flex-direction: column; gap: 12px; }
        .menu-btn {
            padding: 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; font-weight: 500; cursor: pointer;
            background: var(--card-bg); color: var(--text-primary);
            display: flex; align-items: center; gap: 12px;
            transition: all 0.2s;
        }
        .menu-btn:hover { border-color: var(--accent-yellow); background: var(--card-bg); }
        .menu-btn.primary { background: var(--accent-yellow); color: var(--text-on-accent); border-color: var(--accent-yellow); font-weight: 700; }
        .menu-btn.primary:hover { background: var(--accent-yellow-dark); border-color: var(--accent-yellow-dark); }
        .menu-btn i { width: 20px; text-align: center; }

        .top-settings { display: flex; justify-content: flex-end; }
        .theme-toggle {
            background: var(--card-bg); border: 2px solid var(--border); color: var(--text-secondary);
            font-size: 1rem; cursor: pointer; border-radius: 50%; width: 40px; height: 40px;
        }
        .theme-toggle:hover { color: var(--text-primary); border-color: var(--text-primary); }

        /* --- –≠–ö–†–ê–ù –¢–ï–°–¢–ê --- */
        .quiz-header { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; }
        .progress-bar { flex: 1; height: 12px; background: var(--border); border-radius: 6px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: var(--accent-yellow); transition: width 0.3s; }
        .progress-text { font-weight: 500; font-size: 0.9rem; color: var(--text-secondary); }

        .question-card { animation: slideIn 0.3s ease-out; }
        .q-id { font-size: 0.9rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; }
        .q-title { font-size: 1.5rem; font-weight: 700; line-height: 1.4; margin-bottom: 30px; color: var(--text-primary); }
        
        .options-list { display: flex; flex-direction: column; gap: 12px; }
        .option {
            background: var(--card-bg);
            border: 2px solid var(--border);
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.4;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .option:hover:not(.disabled) { border-color: var(--accent-yellow-dark); }
        
        .option-marker {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--border);
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .option-marker-icon { font-size: 14px; color: var(--text-on-accent); opacity: 0; }
        
        /* –í—ã–±—Ä–∞–Ω–æ, –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ */
        .option.selected:not(.disabled) { border-color: var(--accent-yellow); background: var(--accent-yellow); }
        .option.selected:not(.disabled) .option-marker { border-color: var(--accent-yellow-dark); background-color: var(--text-on-accent); }
        .option.selected:not(.disabled) .option-marker-icon { opacity: 1; }
        .option.selected:not(.disabled) .option-text { color: var(--text-on-accent); }

        /* –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ */
        .option.correct { background: var(--success-light); border-color: var(--success); }
        .option.correct .option-marker { background: var(--success); border-color: var(--success); }
        .option.correct .option-marker-icon { color: white; opacity: 1; }
        .option.correct .option-marker-icon::after { content: '‚úì'; }
        
        .option.incorrect { background: var(--error-light); border-color: var(--error); }
        .option.incorrect .option-marker { background: var(--error); border-color: var(--error); }
        .option.incorrect .option-marker-icon { color: white; opacity: 1; }
        .option.incorrect .option-marker-icon::after { content: '‚úï'; }

        .option.missed { border: 2px dashed var(--success); background: var(--success-light); opacity: 0.8; }
        .option.disabled { cursor: default; }

        /* --- –§–£–¢–ï–† (–ö–ù–û–ü–ö–ê –ü–†–û–í–ï–†–ö–ò) --- */
        .quiz-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: var(--card-bg);
            border-top: 2px solid var(--border);
            z-index: 10;
        }
        .quiz-footer .container { padding: 0; }
        .check-btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: 700; cursor: pointer; color: var(--text-on-accent);
            background: var(--accent-yellow);
            transition: all 0.2s;
        }
        .check-btn:disabled { background: var(--border); color: var(--text-secondary); cursor: not-allowed; }
        .check-btn.correct { background: var(--success); color: white; }
        .check-btn.incorrect { background: var(--error); color: white; }

        /* --- –≠–ö–†–ê–ù –†–ï–ó–£–õ–¨–¢–ê–¢–û–í --- */
        .result-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin: 30px 0; }
        .stat-box { background: var(--bg-color); border: 2px solid var(--border); padding: 15px; border-radius: 12px; text-align: center; }
        .stat-val { font-size: 1.8rem; font-weight: 700; }
        .stat-label { font-size: 0.9rem; color: var(--text-secondary); }
        .stat-val.correct { color: var(--success); }
        .stat-val.error { color: var(--error); }

        /* --- –ò–ö–û–ù–ö–ê TG --- */
        .tg-fab {
            position: fixed;
            bottom: 110px; /* –í—ã—à–µ —Ñ—É—Ç–µ—Ä–∞ */
            right: 20px;
            width: 50px; height: 50px; background: var(--tg-color);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 24px; box-shadow: 0 5px 20px rgba(36, 129, 204, 0.4);
            z-index: 100; text-decoration: none; transition: transform 0.3s;
        }
        .tg-fab:hover { transform: scale(1.1); }
        
        /* --- –ê–ù–ò–ú–ê–¶–ò–ò --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div class="container">

        <div id="start-screen" class="screen active">
            <div class="top-settings">
                <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle-btn">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
            <div class="start-header">
                <h1>–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–æ –§–∏–∑–∏–æ–ª–æ–≥–∏–∏</h1>
                <p>–í–æ–ø—Ä–æ—Å—ã 902‚Äì992<br>–ê–Ω–∞—Ç–æ–º–∏—è, –°–ª—é–Ω–æ–æ—Ç–¥–µ–ª–µ–Ω–∏–µ, –ñ–µ–ª—É–¥–æ–∫</p>
            </div>
            
            <div class="start-controls">
                <div id="resume-block" style="display:none; width: 100%;">
                    <button class="menu-btn primary" onclick="startQuiz('resume')">
                        <i class="fas fa-play"></i> &nbsp; –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                    </button>
                </div>
                <button class="menu-btn" onclick="startQuiz('new')">
                    <i class="fas fa-redo"></i> &nbsp; –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ (–ø–æ –ø–æ—Ä—è–¥–∫—É)
                </button>
                <button class="menu-btn" onclick="startQuiz('shuffle')">
                    <i class="fas fa-random"></i> &nbsp; –°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
                </button>
            </div>
        </div>

        <div id="quiz-screen" class="screen">
            <div class="quiz-header">
                <div class="progress-text" id="progress-text">1 / 5</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <div class="question-card" id="question-card">
                <div class="q-id" id="q-id-display">#902</div>
                <div class="q-title" id="q-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="options-list" id="options-list"></div>
            </div>
            </div>

        <div id="result-screen" class="screen">
            <div class="start-header" style="margin:0;">
                <h1 id="result-title">–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!</h1>
                <p id="result-subtitle" style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span id="final-score">0%</span></p>
            </div>
            <div class="result-stats">
                <div class="stat-box">
                    <div class="stat-val correct" id="correct-val">0</div>
                    <div class="stat-label">–í–µ—Ä–Ω–æ</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val error" id="error-val">0</div>
                    <div class="stat-label">–û—à–∏–±–∫–∏</div>
                </div>
            </div>
            <div class="start-controls">
                 <button class="menu-btn primary" id="mistakes-btn" onclick="startQuiz('mistakes')" style="display:none">
                    <i class="fas fa-bug"></i> &nbsp; –†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏
                </button>
                <button class="menu-btn" onclick="location.reload()">
                    <i class="fas fa-home"></i> &nbsp; –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                </button>
            </div>
        </div>
    </div>

    <div class="quiz-footer" id="quiz-footer" style="display: none;">
        <div class="container">
            <button class="check-btn" id="check-btn" onclick="handleMainClick()" disabled>
                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
            </button>
        </div>
    </div>
    
    <a href="https://t.me/stewonly" target="_blank" class="tg-fab">
        <i class="fab fa-telegram-plane"></i>
    </a>

    <script>
        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• –í–û–ü–†–û–°–û–í (–î–ï–ú–ö–ê, 902-906) ---
        const fullQuizData = [
            {id:902,q:"–£–∫–∞–∂–∏—Ç–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –¥–ª—è –ø–æ–ª–æ–≥–æ –æ—Ä–≥–∞–Ω–∞:",opts:["–∏–º–µ–µ—Ç —Å—Ç—Ä–æ–º—É –∏ –ø–∞—Ä–µ–Ω—Ö–∏–º—É","–∏–º–µ–µ—Ç –ø–∞—Ä–µ–Ω—Ö–∏–º—É –∏ –¥–æ–ª—å—á–∞—Ç–æ–µ —Å—Ç—Ä–æ–µ–Ω–∏–µ","–∏–º–µ–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ø–æ–ª–æ—Å—Ç—å –∏ 3-—Ö —Å–ª–æ–π–Ω—É—é —Å—Ç–µ–Ω–∫—É","–∏–º–µ–µ—Ç —Å—Ç—Ä–æ–º—É –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ø–æ–ª–æ—Å—Ç—å"],correct:[2]},
            {id:903,q:"–£–∫–∞–∂–∏—Ç–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –¥–ª—è –ø–∞—Ä–µ–Ω—Ö–∏–º–∞—Ç–æ–∑–Ω–æ–≥–æ –æ—Ä–≥–∞–Ω–∞:",opts:["–∏–º–µ–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ø–æ–ª–æ—Å—Ç—å –∏ 3-—Ö —Å–ª–æ–π–Ω—É—é —Å—Ç–µ–Ω–∫—É","–∏–º–µ–µ—Ç –ø–∞—Ä–µ–Ω—Ö–∏–º—É –∏ –¥–æ–ª—å—á–∞—Ç–æ–µ —Å—Ç—Ä–æ–µ–Ω–∏–µ","–∏–º–µ–µ—Ç —Å—Ç—Ä–æ–º—É –∏ –ø–∞—Ä–µ–Ω—Ö–∏–º—É","–∏–º–µ–µ—Ç —Å—Ç—Ä–æ–º—É –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ø–æ–ª–æ—Å—Ç—å"],correct:[1,2]},
            {id:904,q:"–ö –ø–∏—â–µ–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è:",opts:["–≥–ª–æ—Ç–∫–∞","—Ä–æ—Ç–æ–≤–∞—è –ø–æ–ª–æ—Å—Ç—å","–∂–µ–ª—É–¥–æ–∫","–Ω–æ—Å–æ–≤–∞—è –ø–æ–ª–æ—Å—Ç—å","–≥–æ—Ä—Ç–∞–Ω—å"],correct:[0,1,2]},
            {id:905,q:"–ö –ø–∏—â–µ–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è:",opts:["—Ç–æ–Ω–∫–∞—è –∫–∏—à–∫–∞","—Å–µ–ª–µ–∑–µ–Ω–∫–∞","–ø–∏—â–µ–≤–æ–¥","–≥–æ—Ä—Ç–∞–Ω—å"],correct:[0,2]},
            {id:906,q:"–ü–æ–ª–æ—Å—Ç—å —Ä—Ç–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞:",opts:["—â–µ–∫–∞–º–∏, –∑—É–±–∞–º–∏, –∑–µ–≤–æ–º, –Ω–µ–±–æ–º","—â–µ–∫–∞–º–∏, –≥—É–±–∞–º–∏, –∑–µ–≤–æ–º, –¥–∏–∞—Ñ—Ä–∞–≥–º–æ–π —Ä—Ç–∞, –Ω–µ–±–æ–º (—Ç–≤–µ—Ä–¥—ã–º –∏ –º—è–≥–∫–∏–º)","—â–µ–∫–∞–º–∏, –≥—É–±–∞–º–∏, –¥–µ—Å–Ω–∞–º–∏ —Å –∑—É–±–∞–º–∏","–¥–µ—Å–Ω–∞–º–∏ —Å –∑—É–±–∞–º–∏, –Ω–µ–±–æ–º (—Ç–≤–µ—Ä–¥—ã–º –∏ –º—è–≥–∫–∏–º), –¥–∏–∞—Ñ—Ä–∞–≥–º–æ–π —Ä—Ç–∞"],correct:[1]}
        ];
        
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let activeQuestions = [];
        let currentIndex = 0;
        let userAnswers = {}; // { "902": { selected: Set, isSubmitted: bool, isCorrect: bool }, ... }
        let currentMode = 'default';
        const storageKey = 'physio_quiz_progress_v6_yandex'; // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è

        // --- DOM –≠–õ–ï–ú–ï–ù–¢–´ ---
        const screens = {
            start: document.getElementById('start-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen')
        };
        const resumeBtn = document.getElementById('resume-block');
        const quizFooter = document.getElementById('quiz-footer');
        const cardContainer = document.getElementById('question-card');
        const qIdEl = document.getElementById('q-id-display');
        const qTextEl = document.getElementById('q-text');
        const optionsList = document.getElementById('options-list');
        const mainBtn = document.getElementById('check-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const mistakesBtn = document.getElementById('mistakes-btn');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            if (localStorage.getItem(storageKey)) {
                resumeBtn.style.display = 'block';
            }
        });

        // --- –õ–û–ì–ò–ö–ê –¢–ï–ú–´ ---
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('gi_theme', 'light');
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('gi_theme', 'dark');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        function loadTheme() {
            if (localStorage.getItem('gi_theme') === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // --- –õ–û–ì–ò–ö–ê –°–¢–ê–†–¢–ê –¢–ï–°–¢–ê ---
        function startQuiz(mode) {
            currentMode = mode;
            
            if (mode === 'resume') {
                if (!loadProgress()) {
                    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ.");
                    startQuiz('new');
                    return;
                }
            } else if (mode === 'mistakes') {
                const mistakeIDs = Object.keys(userAnswers).filter(id => !userAnswers[id].isCorrect);
                if (mistakeIDs.length === 0) {
                     alert("–ù–µ—Ç –æ—à–∏–±–æ–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!");
                     return;
                }
                activeQuestions = fullQuizData.filter(q => mistakeIDs.includes(q.id.toString()));
                currentIndex = 0;
                userAnswers = {}; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞
            } else { // 'new' or 'shuffle'
                activeQuestions = JSON.parse(JSON.stringify(fullQuizData)); 
                if (mode === 'shuffle') {
                    shuffleArray(activeQuestions);
                    activeQuestions.forEach(q => {
                        const correctOriginalTexts = q.correct.map(idx => q.opts[idx]);
                        shuffleArray(q.opts);
                        q.correct = correctOriginalTexts.map(text => q.opts.findIndex(opt => opt === text));
                    });
                }
                currentIndex = 0;
                userAnswers = {};
                localStorage.removeItem(storageKey);
            }

            switchScreen('quiz');
            renderQuestion(true);
        }
        
        // --- –õ–û–ì–ò–ö–ê –†–ï–ù–î–ï–†–ê –í–û–ü–†–û–°–ê ---
        function renderQuestion(isFirstLoad = false) {
            const q = activeQuestions[currentIndex];
            if (!q) return;

            if (!userAnswers[q.id]) {
                userAnswers[q.id] = { selected: new Set(), isSubmitted: false, isCorrect: false };
            }
            const state = userAnswers[q.id];

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            progressText.textContent = `${currentIndex + 1} / ${activeQuestions.length}`;
            progressFill.style.width = `${((currentIndex + 1) / activeQuestions.length) * 100}%`;
            qIdEl.textContent = `#${q.id}`;
            qTextEl.textContent = q.q;

            // –ê–Ω–∏–º–∞—Ü–∏—è
            cardContainer.style.animation = 'none';
            if (!isFirstLoad) {
                void cardContainer.offsetWidth; // Force reflow
                cardContainer.style.animation = 'slideIn 0.3s ease-out';
            }

            // –†–µ–Ω–¥–µ—Ä –æ–ø—Ü–∏–π
            optionsList.innerHTML = '';
            q.opts.forEach((optText, idx) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.innerHTML = `<div class="option-marker"><i class="option-marker-icon"></i></div><div class="option-text">${optText}</div>`;

                if (state.isSubmitted) {
                    div.classList.add('disabled');
                    if (q.correct.includes(idx)) div.classList.add('correct');
                    else if (state.selected.has(idx)) div.classList.add('incorrect');
                    if (q.correct.includes(idx) && !state.selected.has(idx)) div.classList.add('missed');
                } else {
                    if (state.selected.has(idx)) div.classList.add('selected');
                    div.onclick = () => toggleOption(q.id, idx);
                }
                optionsList.appendChild(div);
            });
            
            updateFooter(state);
        }

        function toggleOption(qId, idx) {
            const state = userAnswers[qId];
            if (state.isSubmitted) return;

            if (state.selected.has(idx)) state.selected.delete(idx);
            else state.selected.add(idx);
            
            const options = document.querySelectorAll('.option');
            options.forEach((opt, i) => {
                if (i === idx) opt.classList.toggle('selected');
            });
            
            updateFooter(state);
        }

        // --- –õ–û–ì–ò–ö–ê –§–£–¢–ï–†–ê/–ö–ù–û–ü–û–ö ---
        function updateFooter(state) {
            if (state.isSubmitted) {
                mainBtn.textContent = (currentIndex === activeQuestions.length - 1) ? "–ó–∞–≤–µ—Ä—à–∏—Ç—å" : "–î–∞–ª–µ–µ";
                mainBtn.disabled = false;
                mainBtn.className = 'check-btn'; // –°–±—Ä–æ—Å —Ü–≤–µ—Ç–∞
                if(state.isCorrect) mainBtn.classList.add('correct');
                else mainBtn.classList.add('incorrect');
            } else {
                mainBtn.textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";
                mainBtn.disabled = (state.selected.size === 0);
                mainBtn.className = 'check-btn'; // –°–±—Ä–æ—Å —Ü–≤–µ—Ç–∞
            }
        }
        
        function handleMainClick() {
            const state = userAnswers[activeQuestions[currentIndex].id];

            if (state.isSubmitted) {
                // –≠—Ç–æ –∫–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ" –∏–ª–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
                if (currentIndex < activeQuestions.length - 1) {
                    currentIndex++;
                    renderQuestion();
                } else {
                    finishQuiz();
                }
            } else {
                // –≠—Ç–æ –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å"
                checkAnswer();
            }
        }

        function checkAnswer() {
            const q = activeQuestions[currentIndex];
            const state = userAnswers[q.id];
            if (state.isSubmitted) return;

            state.isSubmitted = true;
            
            const userArr = Array.from(state.selected).sort();
            const correctArr = [...q.correct].sort();
            state.isCorrect = JSON.stringify(userArr) === JSON.stringify(correctArr);
            
            if (currentMode !== 'mistakes') saveProgress();
            
            renderQuestion(false); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å —Ü–≤–µ—Ç–∞–º–∏
        }

        // --- –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ---
        function finishQuiz() {
            let correctCount = 0;
            activeQuestions.forEach(q => {
                if(userAnswers[q.id] && userAnswers[q.id].isCorrect) {
                    correctCount++;
                }
            });

            const total = activeQuestions.length;
            const percent = Math.round((correctCount / total) * 100);

            document.getElementById('final-score').textContent = `${percent}%`;
            document.getElementById('correct-val').textContent = correctCount;
            document.getElementById('error-val').textContent = total - correctCount;

            const icon = document.getElementById('result-icon');
            const title = document.getElementById('result-title');
            if (percent === 100) {
                icon.textContent = "üèÜ";
                title.textContent = "–ò–¥–µ–∞–ª—å–Ω–æ!";
            } else if (percent >= 80) {
                icon.textContent = "üéâ";
                title.textContent = "–û—Ç–ª–∏—á–Ω–æ!";
            } else if (percent >= 50) {
                icon.textContent = "üëç";
                title.textContent = "–ù–µ–ø–ª–æ—Ö–æ!";
            } else {
                icon.textContent = "üß†";
                title.textContent = "–°—Ç–æ–∏—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å";
            }

            if (correctCount < total && currentMode !== 'mistakes') {
                mistakesBtn.style.display = 'flex';
            } else {
                mistakesBtn.style.display = 'none';
            }

            switchScreen('result');
            
            if (currentMode !== 'mistakes') {
                localStorage.removeItem(storageKey);
            }
        }

        function saveProgress() {
            const serializableAnswers = {};
            for (const id in userAnswers) {
                serializableAnswers[id] = {
                    ...userAnswers[id],
                    selected: Array.from(userAnswers[id].selected)
                };
            }
            
            const progress = {
                currentMode: currentMode,
                currentIndex: currentIndex,
                rawQuestions: activeQuestions, 
                answers: serializableAnswers
            };
            localStorage.setItem(storageKey, JSON.stringify(progress));
        }

        function loadProgress() {
            const savedData = JSON.parse(localStorage.getItem(storageKey));
            if (!savedData) return false;
            
            currentMode = savedData.currentMode;
            currentIndex = savedData.currentIndex;
            activeQuestions = savedData.rawQuestions; 
            
            userAnswers = savedData.answers;
            for (const id in userAnswers) {
                if (userAnswers[id]) {
                    userAnswers[id].selected = new Set(userAnswers[id].selected);
                }
            }
            return true;
        }
        
        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[screenName].classList.add('active');
            
            if(screenName === 'quiz') {
                quizFooter.style.display = 'block';
            } else {
                quizFooter.style.display = 'none';
            }
        }

        // --- –•–ï–õ–ü–ï–† ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –° –ö–õ–ê–í–ò–ê–¢–£–†–´ ---
        document.addEventListener('keydown', (e) => {
            if (screens.quiz.classList.contains('active')) {
                if (e.key === 'Enter') mainBtn.click();
            }
        });
        
    </script>
</body>
</html>
