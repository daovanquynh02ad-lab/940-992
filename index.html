<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Тренажер по Физиологии (902-992)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #F5F5F5;
            --card-bg: #FFFFFF;
            --border-color: #E0E0E0;
            --text-primary: #000000;
            --text-secondary: #555555;
            
            --correct-bg: #2ECC71; 
            --incorrect-bg: #FF6B6B;
            --btn-blue: #007BFF;
            --btn-hover: #0056b3;
            --btn-gray: #F0F0F0;
            --btn-gray-hover: #E0E0E0;
            
            --tg-color: #2481cc;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px 80px 10px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- СТАРТОВЫЙ ЭКРАН --- */
        .start-screen {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 25px;
            text-align: center;
        }
        .start-screen h1 {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .start-screen p {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }
        .start-controls { display: flex; flex-direction: column; gap: 10px; }
        .btn {
            padding: 12px 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: var(--btn-gray);
            color: #333;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .btn:hover { background-color: var(--btn-gray-hover); }
        .btn-primary { background-color: var(--btn-blue); color: white; border-color: var(--btn-blue); }
        .btn-primary:hover { background-color: var(--btn-hover); border-color: var(--btn-hover); }

        /* --- ЭКРАН ТЕСТА --- */
        .quiz-screen { display: none; /* Скрыт по умолчанию */ }
        .quiz-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .question-header {
            text-align: center;
            padding: 10px;
            background-color: #E0E0E0;
            border-bottom: 1px solid #999;
        }
        .question-header h2 {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .question-text {
            font-size: 1rem;
            font-weight: bold;
            line-height: 1.4;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .options-list { display: flex; flex-direction: column; }

        .option-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.1s ease;
            font-size: 1rem;
        }
        .option-item:last-child { border-bottom: none; }
        
        .option-item.selected:not(.submitted) {
            background-color: #FFF2CC; /* Желтый фон при выборе */
        }
        
        /* ИСПРАВЛЕНО: Цифры теперь черные по умолчанию */
        .option-number {
            font-weight: normal;
            margin-right: 10px;
            min-width: 20px;
            color: #000000; /* Четкий черный цвет для цифр */
            transition: color 0.2s;
        }
        
        .option-text {
            color: var(--text-primary);
            transition: color 0.2s;
        }

        /* Состояния после ответа */
        .option-item.correct {
            background-color: var(--correct-bg);
            color: white;
        }
        .option-item.incorrect {
            background-color: var(--incorrect-bg);
            color: white;
        }
        /* ИСПРАВЛЕНО: Цифры становятся белыми на цветном фоне */
        .option-item.correct .option-number,
        .option-item.correct .option-text,
        .option-item.incorrect .option-number,
        .option-item.incorrect .option-text {
            color: white;
        }
        
        .option-item.missed {
            outline: 2px dashed var(--correct-bg);
            outline-offset: -2px;
            background: #f0fff4;
        }
        
        .option-item.submitted { cursor: default; }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            border-top: 1px solid var(--border-color);
        }
        .btn-nav {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: 100px;
        }
        .btn-nav:hover:not(:disabled) { background-color: #e6e6e6; }
        .btn-nav:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-action {
            background-color: var(--btn-blue);
            color: white;
            border-color: var(--btn-blue);
            font-weight: bold;
        }
        .btn-action:hover:not(:disabled) { background-color: var(--btn-hover); }

        /* --- ЭКРАН РЕЗУЛЬТАТОВ --- */
        .result-screen {
            display: none;
            text-align: center;
        }
        .result-score { font-size: 3rem; font-weight: bold; color: var(--btn-blue); margin: 20px 0; }
        .result-message { font-size: 1.1rem; margin-bottom: 25px; }

        /* --- ИКОНКА TG --- */
        .tg-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--tg-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            text-decoration: none;
            z-index: 100;
        }
        .tg-float:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="start-screen" id="start-screen">
            <h1>Тренажер по Физиологии</h1>
            <p>Вопросы №902–992 (ЖКТ)</p>
            <div class="start-controls">
                <button class="btn btn-primary" onclick="startQuiz('default')">
                    <i class="fas fa-play" style="margin-right: 8px;"></i> Начать тест
                </button>
                <button class="btn" onclick="startQuiz('shuffle')">
                    <i class="fas fa-random" style="margin-right: 8px;"></i> Перемешать вопросы
                </button>
                <button class="btn" id="resume-btn" style="display: none;" onclick="startQuiz('resume')">
                    <i class="fas fa-history" style="margin-right: 8px;"></i> Продолжить
                </button>
            </div>
        </div>

        <div class="quiz-screen" id="quiz-screen">
            <div class="quiz-card">
                <div class="question-header">
                    <h2>Задание №<span id="question-id">902</span>
                        (<span id="current-q-num">1</span> из <span id="total-q-num">91</span>)
                    </h2>
                </div>
                <div class="question-text" id="question-text">Загрузка вопроса...</div>
                <div class="options-list" id="options-area"></div>
                <div class="controls">
                    <button class="btn btn-nav" id="prev-btn" onclick="goToPrev()">← Назад</button>
                    <button class="btn btn-nav btn-action" id="action-btn" onclick="checkAnswer()">Ответить</button>
                    <button class="btn btn-nav" id="next-btn" onclick="goToNext()">Вперед →</button>
                </div>
            </div>
        </div>

        <div class="start-screen result-screen" id="result-screen">
            <h2>Тест завершен!</h2>
            <div class="result-score" id="final-score">0%</div>
            <p class="result-message">Верно: <span id="correct-count">0</span> / <span id="total-count">0</span></p>
            <div class="start-controls">
                <button class="btn" id="mistakes-btn" style="display: none;" onclick="startQuiz('mistakes')">
                    <i class="fas fa-redo" style="margin-right: 8px;"></i> Работа над ошибками
                </button>
                <button class="btn btn-primary" onclick="location.reload()">
                    <i class="fas fa-home" style="margin-right: 8px;"></i> В начало
                </button>
            </div>
        </div>

    </div>

    <a href="https://t.me/stewonly" target="_blank" class="tg-float">
        <i class="fab fa-telegram-plane"></i>
    </a>

    <script>
        // --- БАЗА ВОПРОСОВ ---
        const fullQuizData = [
            {id:902,q:"Укажите особенности, характерные для полого органа:",opts:["имеет строму и паренхиму","имеет паренхиму и дольчатое строение","имеет внутреннюю полость и 3-х слойную стенку","имеет строму и внутреннюю полость"],correct:[2]},
            {id:903,q:"Укажите особенности, характерные для паренхиматозного органа:",opts:["имеет внутреннюю полость и 3-х слойную стенку","имеет паренхиму и дольчатое строение","имеет строму и паренхиму","имеет строму и внутреннюю полость"],correct:[1,2]},
            {id:904,q:"К пищеварительной системе относятся:",opts:["глотка","ротовая полость","желудок","носовая полость","гортань"],correct:[0,1,2]},
            {id:905,q:"К пищеварительной системе относятся:",opts:["тонкая кишка","селезенка","пищевод","гортань"],correct:[0,2]},
            {id:906,q:"Полость рта ограничена:",opts:["щеками, зубами, зевом, небом","щеками, губами, зевом, диафрагмой рта, небом (твердым и мягким)","щеками, губами, деснами с зубами","деснами с зубами, небом (твердым и мягким), диафрагмой рта"],correct:[1]},
            {id:907,q:"Полость рта делится на отделы:",opts:["собственно полость рта и преддверие рта","губы, полость рта и собственно полость рта","щечная область, полость рта и преддверие рта"],correct:[0]},
            {id:908,q:"Секреторная функция в полости рта осуществляется",opts:["только подъязычной слюнной железой","только поднижнечелюстной слюнной железой","малыми и большими слюнными железами","только околоушной слюнной железой"],correct:[2]},
            {id:909,q:"Зев состоит из:",opts:["задней стенки глотки","небные дужки и мягкое небо","пустого пространства","небных дужек, мягкого неба, корня языка"],correct:[3]},
            {id:910,q:"Глотка состоит из:",opts:["3-х частей","2-х частей","4-х частей"],correct:[0]},
            {id:911,q:"Глотка состоит из:",opts:["ротоглотки, носоглотки, гортани","ротоглотки, гортаноглотки, носоглотки","ротоглотки, гортаноглотки, зева","носоглотки, задней стенки, зева"],correct:[1]},
            {id:912,q:"Пищевод –",opts:["имеет четыре сужения","паренхиматозный орган","имеет три сужения","полый орган"],correct:[2,3]},
            {id:913,q:"Мышечная оболочка пищевода состоит из:",opts:["3-х слоев","4-х слоев","2-х слоев","1-го слоя"],correct:[2]},
            {id:914,q:"Желудок состоит из:",opts:["кардиальной части, дна, тела, привратниковой части","дна, тела, ампулы","дна, тела, шейки"],correct:[0]},
            {id:915,q:"Стенка желудка состоит из следующих оболочек:",opts:["мышечной","серозной","адвентициальной","слизистой"],correct:[0,1,3]},
            {id:916,q:"Назовите слои мышечной оболочки желудка:",opts:["круговой","косой","перистый","продольный"],correct:[0,1,3]},
            {id:917,q:"Депонирующая функция желудка осуществляется его:",opts:["привратниковой частью","дном","телом"],correct:[1]},
            {id:918,q:"Какими клетками желудочных желез секретируются пепсины?",opts:["париетальными","эндокринными","главными","добавочными"],correct:[2]},
            {id:919,q:"Какими клетками желудочных желез секретируется соляная кислота?",opts:["мукоцитами","обкладочными","добавочными","главными"],correct:[1]},
            {id:920,q:"Какими клетками желудочных желез секретируется слизь?",opts:["добавочными","главными","эндокринными","обкладочными"],correct:[0]},
            {id:921,q:"Поджелудочная железа –",opts:["полый орган","выделяет панкреатический сок","паренхиматозный орган","выделяет желчь"],correct:[1,2]},
            {id:922,q:"В поджелудочной железе выделяют:",opts:["головку","хвост","ножку","перешеек","тело"],correct:[0,1,4]},
            {id:923,q:"Печень -",opts:["паренхиматозный орган","полый орган","выделяет панкреатический сок","выделяет желчь"],correct:[0,3]},
            {id:924,q:"В печени выделяют:",opts:["призматическую и квадратную доли","переднюю и заднюю доли","левую и правую доли","верхнюю и нижнюю доли"],correct:[2]},
            {id:925,q:"Структурно-функциональной единицей печени является:",opts:["долька","нефрон","ацинус"],correct:[0]},
            {id:926,q:"В желчном пузыре выделяют:",opts:["хвост","дно","шейку","тело","ножку"],correct:[1,2,3]},
            {id:992,q:"Одновременная и полная характеристика секреторной и моторной функции желудка осуществляется с помощью:",opts:["зондирования желудка","рентгеноскопии","рентгенографии","электрогастрографии"],correct:[0]}
        ];
        
        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        let activeQuestions = []; // Массив вопросов для текущей сессии (может быть перемешан или отфильтрован)
        let currentIndex = 0;
        let userAnswers = {}; // { "902": { selected: Set, isSubmitted: bool, isCorrect: bool }, ... }
        let currentMode = 'default'; // default, shuffle, mistakes
        const storageKey = 'physio_quiz_progress';

        // --- DOM ЭЛЕМЕНТЫ ---
        const screens = {
            start: document.getElementById('start-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen')
        };
        const resumeBtn = document.getElementById('resume-btn');
        const qIdEl = document.getElementById('question-id');
        const qTextEl = document.getElementById('question-text');
        const currentQNumEl = document.getElementById('current-q-num');
        const totalQNumEl = document.getElementById('total-q-num');
        const optionsAreaEl = document.getElementById('options-area');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const actionBtn = document.getElementById('action-btn');

        // --- ИНИЦИАЛИЗАЦИЯ ---
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem(storageKey)) {
                resumeBtn.style.display = 'block';
            }
        });

        // --- ЛОГИКА СТАРТА ---
        function startQuiz(mode) {
            currentMode = mode;
            
            if (mode === 'resume') {
                loadProgress();
            } else if (mode === 'mistakes') {
                const mistakeIDs = Object.keys(userAnswers).filter(id => !userAnswers[id].isCorrect);
                activeQuestions = fullQuizData.filter(q => mistakeIDs.includes(q.id.toString()));
                currentIndex = 0;
                userAnswers = {}; // Сбрасываем ответы для режима "Работа над ошибками"
            } else { // 'default' or 'shuffle'
                activeQuestions = [...fullQuizData];
                if (mode === 'shuffle') {
                    activeQuestions.sort(() => Math.random() - 0.5);
                }
                currentIndex = 0;
                userAnswers = {};
                localStorage.removeItem(storageKey);
            }
            
            if (activeQuestions.length === 0) {
                 alert("Нет ошибок для работы!");
                 return;
            }

            screens.start.style.display = 'none';
            screens.result.style.display = 'none';
            screens.quiz.style.display = 'block';
            
            totalQNumEl.textContent = activeQuestions.length;
            renderQuestion();
        }

        // --- ЛОГИКА РЕНДЕРА ВОПРОСА ---
        function renderQuestion() {
            const q = activeQuestions[currentIndex];
            if (!q) return; // На всякий случай

            // Инициализируем состояние, если его нет
            if (!userAnswers[q.id]) {
                userAnswers[q.id] = { selected: new Set(), isSubmitted: false, isCorrect: false };
            }
            const state = userAnswers[q.id];

            // Обновляем UI
            qIdEl.textContent = q.id;
            qTextEl.textContent = q.q;
            currentQNumEl.textContent = currentIndex + 1;

            optionsAreaEl.innerHTML = '';
            q.opts.forEach((optText, idx) => {
                const div = document.createElement('div');
                div.className = 'option-item';
                div.innerHTML = `<span class="option-number">${idx + 1}.</span><span class="option-text">${optText}</span>`;

                if (state.isSubmitted) {
                    div.classList.add('submitted');
                    if (q.correct.includes(idx)) {
                        div.classList.add('correct');
                    } else if (state.selected.has(idx)) {
                        div.classList.add('incorrect');
                    }
                    if (q.correct.includes(idx) && !state.selected.has(idx)) {
                        div.classList.add('missed');
                    }
                } else {
                    if (state.selected.has(idx)) {
                        div.classList.add('selected');
                    }
                    div.onclick = () => toggleOption(q.id, idx);
                }
                optionsAreaEl.appendChild(div);
            });
            
            updateControls(state);
        }

        function toggleOption(qId, idx) {
            const state = userAnswers[qId];
            if (state.isSubmitted) return;

            if (state.selected.has(idx)) {
                state.selected.delete(idx);
            } else {
                state.selected.add(idx);
            }
            renderQuestion();
        }

        // --- ЛОГИКА КНОПОК ---
        function updateControls(state) {
            prevBtn.disabled = (currentIndex === 0);
            
            if (state.isSubmitted) {
                actionBtn.textContent = "Отвечено";
                actionBtn.disabled = true;
                nextBtn.disabled = false;
            } else {
                actionBtn.textContent = "Ответить";
                actionBtn.disabled = (state.selected.size === 0);
                nextBtn.disabled = true; // Нельзя перелистнуть, не ответив
            }

            if (currentIndex === activeQuestions.length - 1) {
                nextBtn.textContent = "Завершить";
                nextBtn.onclick = showResults;
            } else {
                nextBtn.textContent = "Вперед →";
                nextBtn.onclick = goToNext;
            }
        }

        function checkAnswer() {
            const q = activeQuestions[currentIndex];
            const state = userAnswers[q.id];
            if (state.isSubmitted) return;

            state.isSubmitted = true;
            
            const userArr = Array.from(state.selected).sort();
            const correctArr = [...q.correct].sort();
            state.isCorrect = JSON.stringify(userArr) === JSON.stringify(correctArr);
            
            if (currentMode !== 'mistakes') {
                saveProgress();
            }
            renderQuestion();
        }

        function goToNext() {
            if (currentIndex < activeQuestions.length - 1) {
                currentIndex++;
                renderQuestion();
            }
        }

        function goToPrev() {
            if (currentIndex > 0) {
                currentIndex--;
                renderQuestion();
            }
        }

        // --- РЕЗУЛЬТАТЫ И СОХРАНЕНИЕ ---
        function showResults() {
            let correctCount = 0;
            for (const id in userAnswers) {
                if (userAnswers[id].isCorrect) {
                    correctCount++;
                }
            }
            const total = activeQuestions.length;
            const percent = Math.round((correctCount / total) * 100);

            document.getElementById('final-score').textContent = `${percent}%`;
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('total-count').textContent = total;

            const mistakesBtn = document.getElementById('mistakes-btn');
            if (correctCount < total && currentMode !== 'mistakes') {
                mistakesBtn.style.display = 'block';
            } else {
                mistakesBtn.style.display = 'none';
            }

            screens.quiz.style.display = 'none';
            screens.result.style.display = 'block';
            
            // Очищаем сохранение только если это был не режим "ошибок"
            if (currentMode !== 'mistakes') {
                localStorage.removeItem(storageKey);
            }
        }

        function saveProgress() {
            // Конвертируем Set в Array для JSON
            const serializableAnswers = {};
            for (const id in userAnswers) {
                serializableAnswers[id] = {
                    ...userAnswers[id],
                    selected: Array.from(userAnswers[id].selected)
                };
            }
            
            const progress = {
                currentMode: currentMode,
                currentIndex: currentIndex,
                questionOrder: activeQuestions.map(q => q.id), // Сохраняем порядок (важно для shuffle)
                answers: serializableAnswers
            };
            localStorage.setItem(storageKey, JSON.stringify(progress));
        }

        function loadProgress() {
            const savedData = JSON.parse(localStorage.getItem(storageKey));
            if (!savedData) {
                startQuiz('default');
                return;
            }
            
            currentMode = savedData.currentMode;
            currentIndex = savedData.currentIndex;
            // Восстанавливаем порядок вопросов
            activeQuestions = savedData.questionOrder.map(id => fullQuizData.find(q => q.id === id));
            
            // Восстанавливаем ответы и Set'ы
            userAnswers = savedData.answers;
            for (const id in userAnswers) {
                userAnswers[id].selected = new Set(userAnswers[id].selected);
            }
        }
    </script>
</body>
</html>
